# Getting Started with nlp2mcp

This guide will help you get started with nlp2mcp, from installation to your first NLP to MCP conversion.

## Installation

### Requirements
- Python 3.11 or higher
- pip 21.3 or higher

### Install from PyPI

```bash
pip install nlp2mcp
```

Verify installation:

```bash
nlp2mcp --help
```

### Install from Source (Development)

```bash
git clone https://github.com/jeffreyhorn/nlp2mcp.git
cd nlp2mcp
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
make install-dev
```

## Your First Conversion

### 1. Create a Simple NLP Model

Create a file `my_model.gms`:

```gams
Variables x, y, obj;
Equations objective, constraint1;

objective.. obj =E= (x - 2)**2 + (y - 3)**2;
constraint1.. x + y =L= 5;

x.lo = 0; x.up = 10;
y.lo = 0; y.up = 10;

Model mymodel /all/;
Solve mymodel using NLP minimizing obj;
```

### 2. Convert to MCP

```bash
nlp2mcp my_model.gms -o my_mcp.gms
```

This generates `my_mcp.gms` with:
- Stationarity conditions for `x` and `y`
- Complementarity pairs for bounds and inequalities
- Dual variables (`nu_*`, `pi_*`, `rho_*`)

### 3. Review the Output

Open `my_mcp.gms` to see:

```gams
* Generated by nlp2mcp
* KKT System with stationarity, complementarity, and multipliers

Variables
    x
    y
    obj
    nu_objective
    nu_constraint1
    pi_x_lo
    pi_x_up
    pi_y_lo
    pi_y_up
    rho_constraint1
;

Equations
    stat_x
    stat_y
    objective
    constraint1
;

* Stationarity for x
stat_x.. 2 * (x - 2) + nu_constraint1 - pi_x_lo + pi_x_up =E= 0;

* Stationarity for y
stat_y.. 2 * (y - 3) + nu_constraint1 - pi_y_lo + pi_y_up =E= 0;

* Original equations
objective.. obj =E= (x - 2) ** 2 + (y - 3) ** 2;
constraint1.. x + y =L= 5;

Model mcp_model /
    stat_x.x,
    stat_y.y,
    objective.obj,
    constraint1.nu_constraint1,
    x.pi_x_lo,
    x.pi_x_up,
    y.pi_y_lo,
    y.pi_y_up,
    constraint1.rho_constraint1
/;

Solve mcp_model using MCP;
```

## Common Use Cases

### 1. Debugging with Verbose Output

See what nlp2mcp is doing:

```bash
nlp2mcp my_model.gms -o output.gms -v
```

For more detail:

```bash
nlp2mcp my_model.gms -o output.gms -vv
```

### 2. Convexity Warnings (v0.6.0+)

nlp2mcp can detect potentially nonconvex patterns:

```bash
nlp2mcp my_model.gms -o output.gms
```

If your model has nonconvex patterns, you'll see warnings like:

```
⚠️  Convexity Warnings:

  W301: Nonlinear equality constraint detected (may be non-convex)
     Equation: circle_constraint
     Details: Nonlinear equality h(x) = 0
     Docs: https://github.com/jeffreyhorn/nlp2mcp/blob/main/docs/errors/README.md#w301-nonlinear-equality
```

**Suppressing warnings:**

```bash
nlp2mcp my_model.gms -o output.gms --skip-convexity-check
```

See [docs/errors/README.md](errors/README.md) for detailed explanations of each warning.

### 3. Model Statistics

Get information about your model:

```bash
nlp2mcp my_model.gms -o output.gms --stats
```

Output:

```
Model Statistics:
  Variables: 10
  Equations: 8
  Nonzeros: 42
  Density: 52.5%
```

### 4. Exporting Jacobian Structure

For analysis or visualization:

```bash
nlp2mcp my_model.gms -o output.gms --dump-jacobian jacobian.mtx
```

This creates a Matrix Market file with the Jacobian sparsity pattern.

### 5. Scaling for Ill-Conditioned Problems

Apply Curtis-Reid scaling:

```bash
nlp2mcp my_model.gms -o output.gms --scale auto
```

Or variable-based scaling:

```bash
nlp2mcp my_model.gms -o output.gms --scale byvar
```

### 6. Smooth Absolute Value Approximation

For models with `abs()` functions:

```bash
nlp2mcp my_model.gms -o output.gms --smooth-abs
```

This approximates `abs(x)` with `sqrt(x^2 + ε)` where ε=1e-6 by default.

Customize epsilon:

```bash
nlp2mcp my_model.gms -o output.gms --smooth-abs --smooth-abs-epsilon 1e-8
```

## Understanding Error Messages (v0.6.0+)

nlp2mcp provides structured error messages with codes and documentation links.

**Example error:**

```
[E001] Undefined variable 'z' in equation 'my_equation'
  Location: model.gms:10:15
  
  How to fix: Add 'z' to your Variables declaration
  
  Documentation: https://github.com/jeffreyhorn/nlp2mcp/blob/main/docs/errors/README.md#e001-undefined-variable
```

**Error code categories:**
- **E0xx**: Validation errors (undefined variables, type mismatches)
- **E1xx**: Parser errors (syntax errors)
- **W3xx**: Convexity warnings (nonconvex patterns)

See [docs/errors/README.md](errors/README.md) for the complete error catalog.

## Advanced Features

### Expression Simplification

nlp2mcp automatically simplifies derivative expressions:

```bash
# Advanced simplification (default)
nlp2mcp model.gms -o output.gms --simplification advanced

# Basic simplification only
nlp2mcp model.gms -o output.gms --simplification basic

# No simplification (raw derivatives)
nlp2mcp model.gms -o output.gms --simplification none
```

### Configuration Files

Create `pyproject.toml` in your project:

```toml
[tool.nlp2mcp]
simplification = "advanced"
scale = "none"
smooth_abs = false
```

These become your defaults for all conversions.

### Including External Files

nlp2mcp supports `$include` directives:

```gams
$include shared_parameters.gms
$include equations.gms
```

Files are resolved relative to the including file, with nested includes and circular detection.

## Common Patterns

### Indexed Variables and Equations

```gams
Set i /1*10/;
Variables x(i);
Equations balance(i);

balance(i).. sum(j, A(i,j) * x(j)) =E= b(i);
```

nlp2mcp automatically expands indexed structures into individual stationarity conditions.

### Multiple Constraint Types

```gams
Equations
    equality_cons
    inequality_cons;

equality_cons.. x + y =E= 10;      * Creates dual variable nu_equality_cons
inequality_cons.. x - y =L= 5;     * Creates dual variable rho_inequality_cons
```

### Variable Bounds

```gams
x.lo = 0;   * Creates dual variable pi_x_lo
x.up = 100; * Creates dual variable pi_x_up
x.fx = 50;  * Treated as x.lo = x.up = 50
```

## Troubleshooting

### Parse Errors

If you get a parse error, check:
1. Are all variables declared in the `Variables` section?
2. Are all equations declared in the `Equations` section?
3. Is the GAMS syntax valid?

Use `-vv` for detailed error messages.

### Missing Stationarity Conditions

The objective variable does **not** get a stationarity condition. Only decision variables get stationarity equations.

### Very Large Output

For large models, consider:
1. Disable comments: `--no-comments`
2. Use simplification: `--simplification advanced` (default)
3. Check sparsity: `--stats`

### Solver Issues (if running MCP)

nlp2mcp generates the MCP formulation but doesn't solve it. To solve:
1. Load the MCP file in GAMS
2. Use an MCP solver (PATH, MILES, etc.)
3. Check solver logs for convergence

## Next Steps

- **Examples:** Explore `examples/` directory for more models
- **Documentation:** See [README.md](../README.md) for full feature list
- **Error Reference:** Browse [docs/errors/README.md](errors/README.md)
- **Convexity Guide:** Read [docs/errors/convexity_warnings.md](errors/convexity_warnings.md)
- **Roadmap:** Check [docs/roadmap.md](roadmap.md) for upcoming features

## Getting Help

- **Issues:** https://github.com/jeffreyhorn/nlp2mcp/issues
- **Discussions:** https://github.com/jeffreyhorn/nlp2mcp/discussions
- **Documentation:** https://docs.claude.com/en/docs/claude-code/

## Contributing

See [CONTRIBUTING.md](../CONTRIBUTING.md) for guidelines on contributing to nlp2mcp.
