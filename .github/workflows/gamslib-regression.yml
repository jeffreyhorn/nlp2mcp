name: GAMSLib Regression Check

on:
  pull_request:
    paths:
      # Grammar definition
      - "src/gams/grammar.lark"

      # Parser implementation
      - "src/gams/parser.py"
      - "src/ir/parser.py"

      # IR definitions (parser depends on these)
      - "src/ir/symbols.py"
      - "src/ir/ast.py"

      # Ingestion script itself
      - "scripts/ingest_gamslib.py"

      # Regression checker
      - "scripts/check_parse_rate_regression.py"

      # CI workflow (changes to this file)
      - ".github/workflows/gamslib-regression.yml"

  schedule:
    # Weekly validation every Sunday at 00:00 UTC
    - cron: "0 0 * * 0"

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  gamslib-regression:
    name: Test ${{ matrix.model-group }}
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Fail if exceeds 10 minutes

    strategy:
      fail-fast: false
      matrix:
        model-group:
          - all-models # Full GAMSLib suite
      # NOTE: Matrix strategy prepared for future parallel testing.
      # TODO: Add tier1-part1/tier1-part2 groups back when ingestion script
      # supports model filtering to avoid running duplicate tests.

    permissions:
      contents: read # Read repository
      pull-requests: write # Post PR comments

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for baseline comparison
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Download GAMSLib models
        run: |
          # Use cached models if available, download if missing
          if [ ! -d "tests/fixtures/gamslib" ]; then
            echo "Downloading GAMSLib models..."
            ./scripts/download_gamslib_nlp.sh
          else
            echo "Using cached GAMSLib models"
            ls -la tests/fixtures/gamslib/
          fi

      - name: Run GAMSLib ingestion
        run: |
          make ingest-gamslib

      - name: Check for regression
        id: regression-check
        run: |
          # Compare against baseline from main branch (Sprint 12 multi-metric)
          # Enforces thresholds for all 3 metrics: parse rate, convert rate, performance
          # - Parse rate: 5% warn, 10% fail (higher is better)
          # - Convert rate: 5% warn, 10% fail (higher is better)
          # - Performance: 20% warn, 50% fail (lower is better)
          python scripts/check_parse_rate_regression.py \
            --current reports/gamslib_ingestion_sprint8.json \
            --baseline origin/main \
            --parse-warn 0.05 \
            --parse-fail 0.10 \
            --convert-warn 0.05 \
            --convert-fail 0.10 \
            --perf-warn 0.20 \
            --perf-fail 0.50 \
            --verbose | tee regression_output.txt

      - name: Post regression results as PR comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let output = '';
            try {
              output = fs.readFileSync('regression_output.txt', 'utf8');
            } catch (e) {
              output = 'Regression check output not available';
            }

            const body = `## üìä GAMSLib Regression Check Results (Sprint 12 Multi-Metric)

            \`\`\`
            ${output}
            \`\`\`

            <details>
            <summary>About Multi-Metric Thresholds</summary>

            **Sprint 12 Multi-Metric Regression Detection** ‚úÖ

            All three metrics are now enforced with dual warn/fail thresholds:

            | Metric | Direction | Warn Threshold | Fail Threshold | Purpose |
            |--------|-----------|----------------|----------------|---------|
            | **Parse Rate** | Higher is better | 5% drop | 10% drop | Detect parser regressions |
            | **Convert Rate** | Higher is better | 5% drop | 10% drop | Detect converter regressions |
            | **Performance** | Lower is better | 20% increase | 50% increase | Detect performance regressions |

            **Exit Code Behavior:**
            - **0 (PASS):** All metrics pass thresholds
            - **1 (WARN):** ‚â•1 metric warns, none fail (does not block merge)
            - **2 (FAIL):** ‚â•1 metric fails (blocks merge)

            **Status Indicators:**
            - ‚úÖ **PASS:** Metric within acceptable range
            - ‚ö†Ô∏è **WARN:** Metric exceeds warning threshold (review recommended)
            - ‚ùå **FAIL:** Metric exceeds failure threshold (must fix before merge)

            </details>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('GAMSLib Regression Check Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload ingestion report
        uses: actions/upload-artifact@v4
        if: always() # Upload even if regression detected
        with:
          name: gamslib-ingestion-report-${{ matrix.model-group }}
          path: |
            reports/gamslib_ingestion_sprint6.json
            docs/status/GAMSLIB_CONVERSION_STATUS.md
          retention-days: 30

      # NOTE: Dashboard check disabled because CI only has access to 10 test models
      # (downloaded via download_gamslib_nlp.sh) while the committed dashboard is
      # generated from the full 160-model dataset in data/gamslib/raw/. The check
      # would always fail due to this mismatch.
      #
      # To update the dashboard locally, use the full dataset:
      #   python scripts/ingest_gamslib.py --input data/gamslib/raw \
      #     --output reports/gamslib_full.json \
      #     --dashboard docs/status/GAMSLIB_CONVERSION_STATUS.md
      #
      # - name: Check dashboard is up-to-date
      #   if: github.event_name == 'pull_request'
      #   run: |
      #     MEANINGFUL_CHANGES=$(git diff docs/status/GAMSLIB_CONVERSION_STATUS.md | ...)
      #     ...
