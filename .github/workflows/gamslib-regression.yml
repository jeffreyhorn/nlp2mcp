name: GAMSLib Regression Check

on:
  pull_request:
    paths:
      # Grammar definition
      - "src/gams/grammar.lark"

      # Parser implementation
      - "src/gams/parser.py"
      - "src/ir/parser.py"

      # IR definitions (parser depends on these)
      - "src/ir/symbols.py"
      - "src/ir/ast.py"

      # Ingestion script itself
      - "scripts/ingest_gamslib.py"

      # Regression check script
      - "scripts/check_parse_rate_regression.py"

      # CI workflow (changes to this file)
      - ".github/workflows/gamslib-regression.yml"

  schedule:
    # Weekly validation every Sunday at 00:00 UTC
    - cron: "0 0 * * 0"

  # Allow manual triggering for testing
  workflow_dispatch:

# Minimal permissions (principle of least privilege)
permissions:
  contents: read
  pull-requests: read

jobs:
  gamslib-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Fail if exceeds 10 minutes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for baseline comparison
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements.txt

      - name: Download GAMSLib models
        run: |
          # Use cached models if available, download if missing
          if [ ! -d "tests/fixtures/gamslib" ]; then
            echo "Downloading GAMSLib models..."
            ./scripts/download_gamslib_nlp.sh
          else
            echo "Using cached GAMSLib models"
            ls -la tests/fixtures/gamslib/ | head -20
          fi

      - name: Run GAMSLib ingestion
        run: |
          echo "Running GAMSLib ingestion..."
          make ingest-gamslib

      - name: Check for parse rate regression
        run: |
          echo "Checking for parse rate regression..."
          # Note: Report name is sprint6 (baseline established in Sprint 6)
          # This is defined in Makefile's ingest-gamslib target
          python scripts/check_parse_rate_regression.py \
            --current reports/gamslib_ingestion_sprint6.json \
            --baseline origin/main \
            --threshold 0.10

      - name: Upload ingestion report
        uses: actions/upload-artifact@v4
        if: always() # Upload even if regression detected
        with:
          name: gamslib-ingestion-report
          path: |
            reports/gamslib_ingestion_sprint6.json
            docs/status/GAMSLIB_CONVERSION_STATUS.md
          retention-days: 30

      - name: Check dashboard is up-to-date
        if: github.event_name == 'pull_request'
        run: |
          # Check if any parser-related files were modified in this PR
          # If not, skip dashboard check (CI/docs changes don't need dashboard updates)
          git fetch origin ${{ github.base_ref }}
          PARSER_FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^(src/gams/|src/ir/parser\.py|src/ir/symbols\.py|src/ir/ast\.py)' || true)

          if [ -z "$PARSER_FILES_CHANGED" ]; then
            echo "✅ No parser files changed in this PR - skipping dashboard check"
            echo "   (This PR modifies CI/docs/scripts only)"
            exit 0
          fi

          # Parser files changed - check if dashboard is committed
          # Ignore timestamp-only changes (Generated: line)
          # Filter to only actual +/- content lines (not --- or +++ headers), excluding the Generated: timestamp
          DASHBOARD_DIFF=$(git diff docs/status/GAMSLIB_CONVERSION_STATUS.md | grep "^[-+][^-+]" | grep -v "^[-+].*Generated:" || true)

          if [ -z "$DASHBOARD_DIFF" ]; then
            echo "✅ Dashboard is up-to-date (no changes or timestamp-only changes)"
          else
            echo "❌ Dashboard has uncommitted changes"
            echo ""
            echo "Parser files were modified, so dashboard must be updated and committed:"
            echo "  make ingest-gamslib"
            echo "  git add docs/status/GAMSLIB_CONVERSION_STATUS.md"
            echo "  git commit -m 'Update GAMSLib dashboard'"
            echo ""
            echo "Dashboard diff (excluding timestamp):"
            echo "$DASHBOARD_DIFF" | head -50
            exit 1
          fi
